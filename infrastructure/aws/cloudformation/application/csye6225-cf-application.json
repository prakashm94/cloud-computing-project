{
 "AWSTemplateFormatVersion" : "2010-09-09",
 "Description":"Creating ",
 "Parameters": {
   "webSecurityGroupTag" : {
   "Type" : "String"
  },
	"dbSecurityGroupTag" : {
   "Type" : "String"
  },
	"keyTag" : {
   "Type" : "String"
  },
    "s3BucketTag" : {
    "Type" : "String"
    }
 },
 "Resources" : {
	"CodeDeployEC2ServiceRoleInstanceProfile": {
			"Type": "AWS::IAM::InstanceProfile",
			"Properties": {
				"Path": "/",
				"Roles": [
					{"Fn::ImportValue" : "csye6225-cicd-CodeDeployEC2ServiceRole"}
				]
			}
    },
    "DynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "Properties" : {
        "AttributeDefinitions" : [
          {
            "AttributeName" : "id",
            "AttributeType" : "S"   
          }
        ],
        "KeySchema" : [
          {
            "AttributeName" : "id",
            "KeyType" : "HASH"
          }
        ],
        "ProvisionedThroughput" : {
          "ReadCapacityUnits" : "5",
          "WriteCapacityUnits" : "5"
        },
        "TableName" : "csye6225"
      }
      
    },
  "webServerSecurityGroup" : {
   "Type" : "AWS::EC2::SecurityGroup",
   "Properties" : {
    "GroupName" : {"Ref" : "webSecurityGroupTag"},
    "GroupDescription" : "Security tag for web server",
    "SecurityGroupIngress" : [
     {
      "CidrIp" : "0.0.0.0/0",
      "FromPort" : 22,
      "IpProtocol" : "tcp",
      "ToPort" : 22
     },
     {
      "CidrIp" : "0.0.0.0/0",
      "FromPort" : 80,
      "IpProtocol" : "tcp",
      "ToPort" : 80
     },
     {
      "CidrIp" : "0.0.0.0/0",
      "FromPort" : 443,
      "IpProtocol" : "tcp",
      "ToPort" : 443
     },
     {
        "CidrIp": "0.0.0.0/0",
        "FromPort": 8080,
        "IpProtocol": "tcp",
        "ToPort": 8080
      }
     ],
    "VpcId" : {"Fn::ImportValue" : "networkVpcId"} 
   }
  },
  "dbSecurityGroup" : {
		"Type" : "AWS::EC2::SecurityGroup",
		"Properties" : {
		 "GroupName" : {"Ref" : "dbSecurityGroupTag"},
		 "GroupDescription" : "Security tag for web server",
		 "SecurityGroupIngress" : [
			{
			 "SourceSecurityGroupId" : {"Ref" : "webServerSecurityGroup"},
			 "FromPort" : 3306,
			 "IpProtocol" : "tcp",
			 "ToPort" : 3306
			}
		  ],
		 "VpcId" : {"Fn::ImportValue" : "networkVpcId"} 
	  }
	},
	"ec2Instance" : {
	 "Type" : "AWS::EC2::Instance",
	  "Properties" : {
		 "ImageId" : "ami-9887c6e7",
		 "KeyName" : { "Ref" : "keyTag" },
		 "InstanceType" : "t2.micro",
		 "Tags": [
          {
            "Key": "Name",
            "Value": "EC2Instance"
          }
        ],
		"IamInstanceProfile": {
         "Ref": "CodeDeployEC2ServiceRoleInstanceProfile"
        },
		 "DisableApiTermination" : "true",
		 "BlockDeviceMappings": [
			{
			 "DeviceName" : "/dev/sda1",
			 "Ebs" : {
				"VolumeType": "gp2",
				"VolumeSize": "20"
			 }
			}
		 ],
		 "SecurityGroupIds" : [{"Ref": "webServerSecurityGroup"}],
		 "SubnetId" : {"Fn::ImportValue" : "publicSubnetOne"},
		 "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                 "#!/bin/bash -xe ",
                    "yum install ruby ntp wget java-1.8.0-openjdk-devel -y",
                    "echo 'java success'",
                    "systemctl start ntpd",
                    "systemctl enable ntpd",
                    "sudo wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install",
                    "sudo chmod +x ./install",
                    "sudo ./install auto",
                    "echo 'aws install success'",
                    "sudo service codedeploy-agent start",
                    "sudo service codedeploy-agent status",
                    "echo 'starting tomcat'",
                    "groupadd tomcat",
                    "useradd -M -s /bin/nologin -g tomcat -d /opt/tomcat tomcat",
                    "cd /tmp",
                    "wget http://apache.mirrors.pair.com/tomcat/tomcat-8/v8.5.34/bin/apache-tomcat-8.5.34.tar.gz",
                    "mkdir /opt/tomcat",
                    "tar xvf apache-tomcat-8*tar.gz -C /opt/tomcat --strip-components=1",
                    "cd /opt/tomcat",
                    "chgrp -R tomcat /opt/tomcat",
                    "chmod -R g+r conf",
                    "chmod g+x conf",
                    "chown -R tomcat webapps/ work/ temp/ logs/", 
                    "cd ../../../..",            
                    "cd /usr/lib/systemd/system",
                    "touch tomcat.service",
                    "echo '[Unit]' > tomcat.service",
                    "echo 'Description=Apache Tomcat Web Application Container' >> tomcat.service",
                    "echo 'After=syslog.target network.target' >> tomcat.service",
                    "echo '[Service]' >> tomcat.service",
                    "echo 'Type=forking' >> tomcat.service",
                    "echo 'Environment=JAVA_HOME=/usr/lib/jvm/jre' >> tomcat.service",
                    "echo 'Environment=CATALINA_PID=/opt/tomcat/temp/tomcat.pid' >> tomcat.service",
                    "echo 'Environment=CATALINA_HOME=/opt/tomcat' >> tomcat.service",
                    "echo 'Environment=CATALINA_BASE=/opt/tomcat' >> tomcat.service",
                    "echo 'Environment=\"CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC\"' >> tomcat.service",
                    "echo 'Environment=\"JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom\"' >> tomcat.service",
                    "echo 'ExecStart=/opt/tomcat/bin/startup.sh' >> tomcat.service",
                    "echo 'ExecStop=/bin/kill -15 $MAINPID' >> tomcat.service",
                    "echo 'User=tomcat' >> tomcat.service",
                    "echo 'Group=tomcat' >> tomcat.service",
                    "echo 'UMask=0007' >> tomcat.service",
                    "echo 'RestartSec=10' >> tomcat.service",
                    "echo 'Restart=always' >> tomcat.service",
                    "echo '[Install]' >> tomcat.service",
                    "echo 'WantedBy=multi-user.target' >> tomcat.service",
                    "systemctl daemon-reload",
                    "systemctl enable tomcat.service",
                    "systemctl start tomcat.service",
                    "echo 'everything success'",
                
                "echo '#!/bin/sh' >> /opt/tomcat/bin/setenv.sh ",
          {
            "Fn::Sub": "sudo echo \"JAVA_OPTS=\\\"\\$JAVA_OPTS -Dspring.profiles.active=dev\\\"\" >> /opt/tomcat/bin/setenv.sh"
          },
          {
            "Fn::Sub": "echo 'JAVA_OPTS=\"$JAVA_OPTS -Dspring.datasource.url=jdbc:mysql://${myRDSInstance.Endpoint.Address}:3306/csye6225\"' >> /opt/tomcat/bin/setenv.sh"
          },
          {
            "Fn::Sub": "echo 'JAVA_OPTS=\"$JAVA_OPTS -Dspring.datasource.username=rootuser\"' >> /opt/tomcat/bin/setenv.sh"
          },
          {
            "Fn::Sub": "echo 'JAVA_OPTS=\"$JAVA_OPTS -Dspring.datasource.password=rds-instance\"' >> /opt/tomcat/bin/setenv.sh"
          },
          {
            "Fn::Sub": "echo 'JAVA_OPTS=\"$JAVA_OPTS -Dbucket.name=${s3BucketTag}\"' >> /opt/tomcat/bin/setenv.sh"
          },




                "sudo service tomcat restart ",
                "echo 'successful'"
              ]
            ]
          }
        }
	 }
	},
 "myDBSubnetGroup" : {
      "Type" : "AWS::RDS::DBSubnetGroup",
      "Properties" : {
         "DBSubnetGroupDescription" : "Subnet description of db subnets",
         "SubnetIds" : [ {"Fn::ImportValue" : "privateSubnetOne"},
          {"Fn::ImportValue" : "privateSubnetTwo"} ],
         "Tags" : [ {"Key" : "Name", "Value" : "dbSubnetGroup"} ]
      }
   },
    "myRDSInstance" : {
      "Type" : "AWS::RDS::DBInstance",
      "Properties" : {
         "DBName" : "csye6225",
         "AllocatedStorage" : "20",
         "Engine" : "MySQL",
        "EngineVersion" : "5.6.37",
        "DBInstanceClass" : "db.t2.medium",
        "MultiAZ" : false,
        "DBInstanceIdentifier" : "csye6225-fall2018",
        "MasterUsername" : "rootuser",
        "MasterUserPassword" : "rds-instance",
        "DBSubnetGroupName" : {"Ref" : "myDBSubnetGroup"},
        "PubliclyAccessible" : false,
        "VPCSecurityGroups" : [{"Ref": "dbSecurityGroup"}]
      }
   },
   "s3Bucket" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "BucketName" : {"Ref" : "s3BucketTag"}
      }
   } 	
 }
}
